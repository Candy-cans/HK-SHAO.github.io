<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>函数大冒险（开发中v1.6）</title>
    <style type="text/css">
        #father {
            position: relative;
            margin: 0px auto;
            border: dotted;
        }
        #father #gc {
            position: absolute;
            opacity: 0.8;
            z-index: 2;
        }
        #father #gc2 {
            position: absolute;
            z-index: 1;
        }
    </style>
</head>

<body>
    <h1 align="center">函数大冒险</h1>
    <div id="father">
        <canvas id="gc"></canvas>
        <canvas id="gc2"></canvas>
    </div>
    <div style="text-align: center">
        <h2>输入表达式</h2>
        <textarea id="ed" oninput="inChange()" rows="1" cols="50" style="font-size:20px;font-weight:bold;text-align:center"></textarea>
        <br>
        <br>
        <button id="bu" onclick="buOnClick()" style="width:100px;height:40px">下一关</button>
    </div>
    <br>
    <div style="position:fixed; bottom:0px; right:20px">
        <h3 id="outm"></h3>
        <h3 id="mes"></h3>
    </div>
    <br><br><br>
    <h3>游戏说明（每关满分20000分，目前有58个关卡）</h3>
    <div>
        过关条件：输入表达式，并尽可能高的拟合灰色线条或者灰色区域，使残差降到0.2以下
        <br>如果你过关了，你还可以尝试挑战将残差降低到0，残差越低得分越高。
        <br>注意：即便你拟合的很好，你也不一定能过关；即便你没有完全拟合，你也有几率过关，
        <br>原因在于你看到的是“训练集”样本，在区间[-1,1]之间，
        <br>而计算残差的“测试集”样本不一定与“训练集”样本相同。
        <br>不要出现类似于 2x/2x 这样的表达式，因为当 x=0 时，会出现未定式。
        <br>
        <br>游戏正在开发中，目前还处于极度不完善状态，很多bug，为保证游戏性请不要卡bug过关。开发者：烧风
        <br>悄悄告诉你：在游戏测试阶段可以输入 0/0 或者 NaN 进行跳关，请适度使用，否则会破坏游戏性
        <br>图像的绘制范围固定在区间[-1,1]中，你可通过图像的平移和缩放得到你想要的效果
        <br>绘制图像可以直接输入函数绘制曲线，例如 sin(x) x^x gamma(x) E^x isPrime(x) x%0.5 等
        <br>支持参数方程（参数为k）绘制曲线，例如 [k,k] [k,k^2]/2-0.25 等
        <br>支持输入不等式绘制平面区域（支持与或运算），例如 sin(x)&lt;y and y&lt;-0.2 等
        <br>支持极坐标绘制曲线或者平面区域（使用 ρ 和 θ ），例如 ρ&lt;0.5 ρ&lt;θ ρ-0.1 等
        <br>你每改变一次输入框里的内容就会执行一次math.js的evaluate函数（参考文档：https://mathjs.org/）
        <br>表达式只要返回的是number或者boolean就可以绘制图像，所以玩法很多，就等待着你自己探索了
        <br>下面是math库的部分函数说明（实际上支持非常多的函数比如各种操作矩阵的函数，具体请参考math.js）
    </div>
    </p>
    <h3>部分常量（参考https://mathjs.org/docs/reference/constants.html）</h3>
    <table class="reference">
        <tbody>
            <tr>
                <th width="20%" align="left">属性</th>
                <th width="80%" align="left">描述</th>
            </tr>
            <tr>
                <td>
                    <a></a>E</a>
                </td>
                <td>返回自然对数的底数（约等于2.718）</td>
            </tr>
            <tr>
                <td><a>LN2</a>
                </td>
                <td>返回 2 的自然对数（约等于0.693）</td>
            </tr>
            <tr>
                <td><a>LN10</a>
                </td>
                <td>返回 10 的自然对数（约等于2.302）</td>
            </tr>
            <tr>
                <td><a>PI</a>
                </td>
                <td>返回圆周率（约等于3.14159）</td>
            </tr>
            <tr>
                <td><a>SQRT2</a>
                </td>
                <td>返回 2 的平方根（约等于 1.414）</td>
            </tr>
        </tbody>
    </table>
    <h3>部分函数（参考https://mathjs.org/docs/reference/functions.html）</h3>
    <table class="reference">
        <tbody>
            <tr>
                <th width="20%" align="left">属性</th>
                <th width="80%" align="left">描述</th>
            </tr>
            <tr>
                <td><a>abs(x)</a>
                </td>
                <td>返回 x 的绝对值</td>
            </tr>
            <tr>
                <td><a>acos(x)</a>
                </td>
                <td>返回 x 的反余弦值</td>
            </tr>
            <tr>
                <td><a>asin(x)</a>
                </td>
                <td>返回 x 的反正弦值</td>
            </tr>
            <tr>
                <td><a>atan(x)</a>
                </td>
                <td>以介于 -PI/2 与 PI/2 弧度之间的数值来返回 x 的反正切值</td>
            </tr>
            <tr>
                <td><a>atan2(y,x)</a>
                </td>
                <td>返回从 x 轴到点 (x,y) 的角度（介于 -PI/2 与 PI/2 弧度之间）</td>
            </tr>
            <tr>
                <td><a>ceil(x)</a>
                </td>
                <td>对数进行上舍入</td>
            </tr>
            <tr>
                <td><a>cos(x)</a>
                </td>
                <td>返回数的余弦</td>
            </tr>
            <tr>
                <td><a>exp(x)</a>
                </td>
                <td>返回 E 的 x 次幂
                </td>
            </tr>
            <tr>
                <td><a>floor(x)</a>
                </td>
                <td>对 x 进行下舍入</td>
            </tr>
            <tr>
                <td><a>log(x)</a>
                </td>
                <td>返回数的自然对数（底为e）</td>
            </tr>
            <tr>
                <td><a>max(x,y,z,...,n)</a>
                </td>
                <td>返回 x,y,z,...,n 中的最高值</td>
            </tr>
            <tr>
                <td><a>min(x,y,z,...,n)</a>
                </td>
                <td>返回 x,y,z,...,n中的最低值</td>
            </tr>
            <tr>
                <td><a>pow(x,y)</a>
                </td>
                <td>返回 x 的 y 次幂</td>
            </tr>
            <tr>
                <td><a>random()</a>
                </td>
                <td>返回 0 ~ 1 之间的随机数</td>
            </tr>
            <tr>
                <td><a>round(x)</a>
                </td>
                <td>四舍五入</td>
            </tr>
            <tr>
                <td><a>sin(x)</a>
                </td>
                <td>返回数的正弦</td>
            </tr>
            <tr>
                <td><a>sqrt(x)</a>
                </td>
                <td>返回数的平方根</td>
            </tr>
            <tr>
                <td><a>tan(x)</a>
                </td>
                <td>返回角的正切</td>
            </tr>
            <tr>
                <td><a>median(a, b, c, …)</a>
                </td>
                <td>返回 a, b, c, … 的中位数</td>
            </tr>
            <tr>
                <td><a>pickRandom([a, b, c, …])</a>
                </td>
                <td>随机返回 a, b, c, … 中的一个</td>
            </tr>
        </tbody>
    </table>
    <div>
        <h3>更新记录</h3>
        v1.6更新说明
        <br>这次增加了几个关卡，支持了极坐标绘图，参数方程绘图，还隐性的支持了迭代（可以画分叉图），支持显示运算结果，可以当计算器用了
    </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.0.0/math.min.js"></script>
<script type="text/javascript">
    dd = 0.2;

    cfa = document.getElementById("father");
    canv = document.getElementById("gc");
    ctx = canv.getContext("2d");
    canv2 = document.getElementById("gc2");
    ctx2 = canv2.getContext("2d");
    ined = document.getElementById("ed");
    bu = document.getElementById("bu");
    mes = document.getElementById("mes");
    outm = document.getElementById("outm");
    x = 0.1;y = 0.1;
    size = Math.min(window.innerWidth, window.innerHeight) * 0.65;
    cfa.style.width = size + "px";
    cfa.style.height = size + "px";
    canv.width = size;
    canv.height = size;
    canv2.width = size;
    canv2.height = size;

    var _0x4247=['bWluKHheMi14LHgp','YWJzKM+BLTAuNSk8MC4x','z4E8MC41KzAuMXNpbigxMM64KQ==','YWJzKM+BLTAuM864KTwwLjAy','c2luKHgpXjIrc2luKHkpXjI8MC41','dGFuKHgpXjIrdGFuKHkpXjI8MC41','c2luKDEweCswLjNzaW4oMTAwMHgpKQ==','bG9nKEUqeCk=','Z2FtbWEoMTB4KS8xMA==','eCBtb2QgMC40','eF54','cG93KHheMyx4KQ==','YWJzKHNpbih4KSk=','KCgyeCleMisoMnkpXjItMSleMzwoMngpXjIoMnkpXjM=','eCp5PDA=','eCp5PDAuMQ==','eDwtMC4yIG9yIHg+MC4y','LTAuODx4PDAuMg==','LTAuMjx4PHk8MC4y','KHgtMC41KV4yK3leMjwwLjEgb3IgKHgrMC41KV4yK3leMjwwLjE=','YWJzKHNpbih4XjIqNSkp','bWF4KHglMC4yLHNpbigxMCpQSSp4KSk=','Z2FtbWEoYWJzKHgpKjEwKS8xMA==','bWF4KHNpbih4KjEwKS8xMCxjb3MoeCoxMCkvMTAp','bG9nKGFicyh4KjUpLTAuMSkvNQ==','eCUoMC4yKStzaW4oeCoxMCkvMTA=','bWF4KDAseCk=','bWF4KDAuMXgseCk=','c2lnbihzaW4oeCoxMCkpLzEw','YXRhbih4KjEuNSk=','dGFuaCh4KjEuNSk=','MS8oMStlXigteCoxMCkp','c2lnbihzaW4oeCoxMDAwKSkvMg==','MC4xc2luKDEweCkrMC4yc2luKDIweCkrMC4zc2luKDMweCkrMC4zNHNpbig0MHgp','KHgrMC41PnkgYW5kIC14KzAuNT55KWFuZCh4LTAuNTx5IGFuZCAteC0wLjU8eSk=','c2luKDEweCklMS0wLjU=','MC4yKmlzUHJpbWUoY2VpbCh4KjIwKSk=','bm9ybShjb3MoaSoxMHgpKS8xMA==','Z2NkKDYsY2VpbCgxMCp4KSkvMTA=','c2luKFBJKih4K3Npbih4KjEwMDApKSk=','eF4y','eDww','MC4xL3g=','YWJzKHgp','YWJzKHheMyk=','c2luKDEweCk8MTB5','c2luKFBJKngp','ZXhwKEUqeCk=','eCUwLjI+eQ==','c3FydCgwLjUteF4yKQ==','eF4yK3g=','eF4yK3leMjwwLjU=','Y2VpbCh4KjEwKS8xMA==','eF4zKzAuMyp4XjItMC41KngtMC4z','eF4xMCt5XjEwPDAuMQ==','dGFuKHheMiozLjgp','Y2VpbCh4KjEwKS8xMCtmbG9vcih4KjEwKS8xMA=='];(function(_0xf8cc3d,_0x19c992){var _0x1c0671=function(_0x4a43b5){while(--_0x4a43b5){_0xf8cc3d['push'](_0xf8cc3d['shift']());}};_0x1c0671(++_0x19c992);}(_0x4247,0xd3));var _0x5afa=function(_0x428b71,_0x171bb0){_0x428b71=_0x428b71-0x0;var _0x1adcc7=_0x4247[_0x428b71];if(_0x5afa['tdTGoM']===undefined){(function(){var _0xa78151=function(){var _0x20f99f;try{_0x20f99f=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x4a7fe7){_0x20f99f=window;}return _0x20f99f;};var _0x1074b1=_0xa78151();var _0x102b41='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x1074b1['atob']||(_0x1074b1['atob']=function(_0x141997){var _0x2cec2f=String(_0x141997)['replace'](/=+$/,'');for(var _0x428119=0x0,_0x3e07ef,_0x51dcaa,_0x3f965b=0x0,_0x44a30c='';_0x51dcaa=_0x2cec2f['charAt'](_0x3f965b++);~_0x51dcaa&&(_0x3e07ef=_0x428119%0x4?_0x3e07ef*0x40+_0x51dcaa:_0x51dcaa,_0x428119++%0x4)?_0x44a30c+=String['fromCharCode'](0xff&_0x3e07ef>>(-0x2*_0x428119&0x6)):0x0){_0x51dcaa=_0x102b41['indexOf'](_0x51dcaa);}return _0x44a30c;});}());_0x5afa['Zanktt']=function(_0xa9eaeb){var _0x2409ef=atob(_0xa9eaeb);var _0x156710=[];for(var _0x179433=0x0,_0x502142=_0x2409ef['length'];_0x179433<_0x502142;_0x179433++){_0x156710+='%'+('00'+_0x2409ef['charCodeAt'](_0x179433)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x156710);};_0x5afa['qOOJOs']={};_0x5afa['tdTGoM']=!![];}var _0x388b7e=_0x5afa['qOOJOs'][_0x428b71];if(_0x388b7e===undefined){_0x1adcc7=_0x5afa['Zanktt'](_0x1adcc7);_0x5afa['qOOJOs'][_0x428b71]=_0x1adcc7;}else{_0x1adcc7=_0x388b7e;}return _0x1adcc7;};levels=['x',_0x5afa('0x0'),_0x5afa('0x1'),_0x5afa('0x2'),_0x5afa('0x3'),_0x5afa('0x4'),_0x5afa('0x5'),_0x5afa('0x6'),_0x5afa('0x7'),_0x5afa('0x8'),_0x5afa('0x9'),_0x5afa('0xa'),_0x5afa('0xb'),_0x5afa('0xc'),_0x5afa('0xd'),_0x5afa('0xe'),_0x5afa('0xf'),_0x5afa('0x10'),_0x5afa('0x11'),_0x5afa('0x12'),_0x5afa('0x13'),_0x5afa('0x14'),_0x5afa('0x15'),_0x5afa('0x16'),_0x5afa('0x17'),_0x5afa('0x18'),_0x5afa('0x19'),_0x5afa('0x1a'),_0x5afa('0x1b'),_0x5afa('0x1c'),_0x5afa('0x1d'),_0x5afa('0x1e'),_0x5afa('0x1f'),_0x5afa('0x20'),_0x5afa('0x21'),_0x5afa('0x22'),_0x5afa('0x23'),_0x5afa('0x24'),_0x5afa('0x25'),_0x5afa('0x26'),_0x5afa('0x27'),_0x5afa('0x28'),_0x5afa('0x29'),_0x5afa('0x2a'),_0x5afa('0x2b'),_0x5afa('0x2c'),_0x5afa('0x2d'),_0x5afa('0x2e'),_0x5afa('0x2f'),_0x5afa('0x30'),_0x5afa('0x31'),_0x5afa('0x32'),_0x5afa('0x33'),_0x5afa('0x34'),_0x5afa('0x35'),_0x5afa('0x36'),_0x5afa('0x37'),_0x5afa('0x38')];
    ses = [
        [-2000, 2000],[-2000, 2000],[],[-100, 100],[-2000, 2000],[-2000, 2000],[],[100, 4100],[-2000, 2000],
        [], [-800, 800],[-2000, 2000],[],[2001, 6001],[-2000, 2000],[],[-2000, 2000],[-3001, 1001],[-2000, 2000],
        [],[],[],
        [],[],[-2000,2000], [-100,4100], [-1000,1000], [-2000,2000], [0,4000], [0,4000], [-2000,2000],
        [],[],[],[],[],[],[],
        [-2000,2000], [-2000,2000], [-300,-200], [-2000,2000], [2000,6000], [-2000,2000],
        [-2000,2000], [-2000,2000], [-2000,2000], [-2000,2000], [-2000,2000], [-2000,2000], [-2000,2000],
        [-2000,2000], [],
        [-2000,2000], [0, 2000], [-500,500], [-2000,2000], [-2000,2000]
    ];
    qab = 0;qa = 0;qb = 0;
    
    ltype = "";
    lvn = 0;
    score = 0;
    R = Infinity;

    reCanvas2();
    reCanvas();
    nextLevel();
    ined.value = "((2x)^2+(2y)^2-1)^3<(2x)^2(2y)^3";//
    plot(ined.value, "red", "boolean");//

    function reMes() {
        mes.innerHTML = "关卡：" + lvn + "；得分：" + score + "；当前残差：" + R;
    }

    function nextLevel() {
        lvn += 1;
        x = 0.1;y = 0.1;
        qab = 0;qa = 0;qb = 0;
        if (R != Infinity && !isNaN(R)) {
            score += Math.trunc(1e5 * (dd - R));
        }
        R = Infinity;
        ined.value = "";
        outm.innerHTML = "";
        if (lvn > levels.length) {
            alert("你已通关！你的平均得分是" + score/levels.length + "分（满分20000）。新的关卡正在开发中...");
            return;
        }
        reCanvas2();
        reCanvas();
        plot2(levels[lvn - 1])
    }

    function buOnClick() {
        nextLevel();
        bu.disabled = true;
        bu.style.border = "1px solid red";
    }

    function reCanvas() {
        canv.width = canv.width;
        bu.disabled = true;
        R = Infinity;
        bu.style.border = "1px solid red";
        reMes();
    }

    function reCanvas2() {
        canv2.width = canv2.width;
        ctx2.strokeStyle = 'gray';
        ctx2.moveTo(size / 2, 0);
        ctx2.lineTo(size / 2, size);
        ctx2.moveTo(0, size / 2);
        ctx2.lineTo(size, size / 2);
        ctx2.stroke();
    }

    function plot(ex, color, type) {
        comp = math.compile(ex);
        reCanvas();
        ctx.fillStyle = color;
        if (type == "boolean") {
            comp2 = math.compile(levels[lvn - 1]);
            jd = size / 200;
            for (var i = 0; i <= size; i += jd) {
                for (var j = 0; j <= size; j += jd) {
                    x = (2 * i - size) / size;
                    y = -(2 * j - size) / size;
                    ans = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
                    if (ans == true) {
                        ctx.fillRect(i, j, jd / 2, jd / 2);
                        qb += 1;
                        if (comp2.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)}) == true) {
                            qab += 1;
                        }
                    }
                }
            }
            if (ltype != "boolean") {
                R = Infinity;
            } else {
                R = parseFloat((Math.tan(0.5*Math.PI*(1-qab/(qa+qb-qab)))/2).toFixed(6));
                if (R > 1e8) {R = Infinity;}
                qab = 0;qb = 0;
            }
            judge();
        } else if (type == "number") {
            for (var i = -10*size; i <= 10*size; i++) {
                x = i / (10*size);
                y = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
                if (typeof y != "number" || y > 1 || y < -1) {
                    continue;
                }
                ctx.fillRect((x + 1) * 0.5 * size - 1, (1 - y) * size * 0.5 - 1, 2, 2);
            }
            if (ltype != "number") {
                R = Infinity;
            } else {
                R = parseFloat(calR(ex, levels[lvn - 1]).toFixed(6));
            }
            judge();
        } else if (type == "object") {
            t = 0.1;
            ob = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x), k: t});
            if (ob._data == undefined || ob._data.length != 2 || typeof ob._data[0] != "number" || typeof ob._data[1] != "number")　{
                return;
            }
            for (var i = 0; i <= 20*size; i++) {
                t = i/(20*size);
                ob = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x), k: t});
                x = ob._data[0];
                y = ob._data[1];
                if (y > 1 || y < -1 || x > 1 || x < -1) {
                    continue;
                }
                ctx.fillRect((x + 1) * 0.5 * size - 1, (1 - y) * size * 0.5 - 1, 2, 2);
            }
        }
    }

    function judge() {
        reMes();
        if (R < dd || isNaN(R)) {
            bu.disabled = false;
            bu.style.border = "1px solid green";
        } else {
            bu.disabled = true;
            bu.style.border = "1px solid red";
        }
    }

    function calR(ex, ex2) {
        r = 0;
        comp = math.compile(ex);
        comp2 = math.compile(ex2);
        start = ses[lvn - 1][0];
        end = ses[lvn - 1][1];
        for (var i = start; i <= end; i++) {
            x = i / 2000;
            y1 = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
            y2 = comp2.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
            if (typeof y2 != "number") {
                continue;
            }
            if (y2 == -Infinity || y2 == Infinity || isNaN(y1)) {
                continue;
            }
            r += Math.abs(y1 - y2);
        }
        return r / (end - start);
    }

    function plot2(ex) {
        comp = math.compile(ex);
        outeval = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
        ltype = typeof outeval;
        ctx2.fillStyle = "gray";
        if (ltype == "boolean") {
            jd = size / 200;
            for (var i = 0; i <= size; i += jd) {
                for (var j = 0; j <= size; j += jd) {
                    x = (2 * i - size) / size;
                    y = -(2 * j - size) / size;
                    if (comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)}) == true) {
                        ctx2.fillRect(i, j, jd / 2, jd / 2);
                        qa += 1;
                    }
                }
            }
        } else if (ltype == "number") {
            for (var i = -10*size; i <= 10*size; i++) {
                x = i / (10*size);
                y = comp.evaluate({x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x)});
                if (typeof y != "number" || y > 1 || y < -1) {
                    continue;
                }
                ctx2.fillRect((x + 1) * 0.5 * size - 1, (1 - y) * size * 0.5 - 1, 2, 2);
            }
        } else if (ltype == "object") {

        }
    }

    function inChange() {
        if (ined.value == "") {
            reCanvas();
            outm.innerHTML = "";
            return;
        }
        x = 0.1;y = 0.1;
        try {
            outeval = math.evaluate(ined.value);
            type = typeof outeval;
            if (type != "function") {
                outm.innerHTML = outeval;
            } else {
                outm.innerHTML = "function";
            }
        } catch (err) {
            outm.innerHTML = "";
            try {
                outeval = math.evaluate(ined.value, {x: x, y: y, ρ: Math.sqrt(x*x+y*y), θ: Math.atan2(y,x), k: 0.1});
            } catch (err) {
                outeval = Infinity;
            }
            type = typeof outeval;
        }
        if(ined.value == "0/0" || ined.value == "NaN") {
            R = NaN;
            judge();
        } else if (Math.abs(outeval) == Infinity || isNaN(outeval) && type != "object"){
            R = Infinity;
            judge();
        } else {
            plot(ined.value, "blue", type);
        }
    }

    ined.addEventListener('keydown',function(e) {
            if(e.keyCode == 13){
                bu.click();
                event.preventDefault();
            }
            return;
        });
</script>

</html>